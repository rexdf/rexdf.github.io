
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
<script type="text/javascript">var _speedMark=new Date</script>
<meta charset="utf-8">
<title>搭了个gitlab - Rexdf</title>
<meta name="author" content="Rexdf">
<meta name="description" content="成果 Pipelines &amp; Jobs GitLab Pages 安装 登录系统初始设置 安装常用软件配置等 安装gitlab依赖 安装gitlab 用户配置 配置CI/CD 自定义域名的GitLab Pages服务 配置GitLab Runner 安装docker 安装gitlab- &hellip;">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' data: https://hm.baidu.com https://tajs.qq.com https://ssl.google-analytics.com https://static.rexdf.org https://*.disquscdn.com https://rexdf.disqus.com https://api.github.com https://ssl.google-analytics.com https://disqus.com https://analytics.rexdf.net; connect-src 'self' https://static.rexdf.org https://analytics.rexdf.net https://hm.baidu.com; img-src data: https://*; font-src data: https://*; child-src 'none'; style-src 'self' 'unsafe-inline' https://*; frame-src 'self' https://t.rexdf.org http://t.rexdf.org https://rexdf.disqus.com https://disqus.com">
<link rel="canonical" href="https://i.rexdf.org/blog/2018/09/12/da-liao-ge-gitlab">
<link rel="dns-prefetch" href="https://static.rexdf.org/">
<link href="/favicon.ico" rel="icon">
<link id="main-css" href="/stylesheets/screen.css" media="screen,projection" rel="stylesheet" type="text/css" title="pc">
<link href="/stylesheets/screen_mobile.css" rel="alternate stylesheet" type="text/css" title="mobile">
<link href="/atom.xml" rel="alternate" title="Rexdf" type="application/atom+xml">
<script src="/javascripts/libs/jquery.min.js"></script>
<script src="/javascripts/octopress-rexdf.min.js" type="text/javascript"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
      }
      
      toggle_theme();
  });
</script>
<script type="text/javascript" async src="https://static.rexdf.org/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/javascript">var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-55590409-1"]),_gaq.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script>
<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?32192d95b89fbefa0875c4c95adb1412";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<script src="/javascripts/fancybox/jquery.fancybox.pack.js"></script>
<link rel="stylesheet" type="text/css" href="/javascripts/fancybox/jquery.fancybox.css">
<script type="text/javascript">var _paq=_paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var e="https://analytics.rexdf.net/";_paq.push(["setTrackerUrl",e+"piwik.php"]),_paq.push(["setSiteId","1"]);var a=document,t=a.createElement("script"),p=a.getElementsByTagName("script")[0];t.type="text/javascript",t.async=!0,t.defer=!0,t.src=e+"piwik.js",p.parentNode.insertBefore(t,p)}()</script>
</head>
<body class="low-contrast-linen-wptouch-bg">
<header role="banner"><hgroup>
<h1 id="header-title"><a href="/">Rexdf</a></h1>
<h2 id="subtitle">The devil is in the Details.</h2>
</hgroup>
</header>
<nav role="navigation"><ul class="subscription" data-subscription="rss">
<li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
</ul>
<form action="https://google.com/search" method="get">
<fieldset role="search">
<input type="hidden" name="q" value="site:i.rexdf.org">
<input class="search" type="text" name="q" results="0" placeholder="Search">
</fieldset>
</form>
<ul class="main-navigation">
<li><a href="/">Blog</a></li>
<li><a href="/blog/archives/">Archives</a></li>
<li><a href="/idea/">Idea</a></li>
<li><a href="/share/">Share</a></li>
<li><a href="/books/">Books</a></li>
<li><a href="/donate/">Donate</a></li>
<li><a target="_blank" href="https://blog.rexdf.org" style="font-family:Shadows Into Light">Main-Blog</a></li>
</ul>
</nav>
<div id="main">
<div id="content">
<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">搭了个gitlab</h1>
<p class="meta">
<time class="data-article month-09 season-autumn" datetime="2018-09-12T14:21:15+08:00" pubdate><span class="month">Sep</span> <span class="day">12th</span> <span class="year">2018</span></time>
| <a href="#disqus_thread" data-disqus-identifier="https://i.rexdf.org">Comments</a>
</p>
</header>
<div class="entry-content"><ul class="markdown-toc">
<li><a href="#section">成果</a><ul>
<li><a href="#pipelines--jobs">Pipelines &amp; Jobs</a></li>
<li><a href="#gitlab-pages">GitLab Pages</a></li>
</ul>
</li>
<li><a href="#section-1">安装</a><ul>
<li><a href="#section-2">登录系统初始设置</a></li>
<li><a href="#section-3">安装常用软件配置等</a></li>
<li><a href="#gitlab">安装gitlab依赖</a></li>
<li><a href="#gitlab-1">安装gitlab</a></li>
<li><a href="#section-4">用户配置</a></li>
</ul>
</li>
<li><a href="#cicd">配置CI/CD</a><ul>
<li><a href="#gitlab-pages-1">自定义域名的GitLab Pages服务</a></li>
<li><a href="#gitlab-runner">配置GitLab Runner</a><ul>
<li><a href="#docker">安装docker</a></li>
<li><a href="#gitlab-runner-1">安装gitlab-runner及其配置</a></li>
<li><a href="#section-5">错误</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#section-6">时间成本</a></li>
<li><a href="#section-7">维护</a><ul>
<li><a href="#section-8">2018年10月2日</a><ul>
<li><a href="#section-9">问题</a></li>
<li><a href="#section-10">探索</a></li>
<li><a href="#section-11">解决</a></li>
<li><a href="#section-12">真实原因</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>今天无意中看见个CN2线路，2核+4GB+4T的VPS，打了下折之后年付18美元。这么便宜，我都不敢把服务商写出来了。当然这是OpenVZ的，目前看来还好，将来不知道会被玩坏成什么样子。</p>
<p>开源的自建git项目托管服务，貌似有模仿github用ruby写的<a href="https://about.gitlab.com/" target="_blank">gitlab</a>，用scala基于JVM的<a href="https://github.com/gitbucket/gitbucket" target="_blank">GitBucket</a>，以及国人用golang开发的<a href="https://github.com/gogs/gogs" target="_blank">gogs/gitea</a>等。功能最完善的当然是gitlab了。 gogs可以跑在路由器、树莓派等低配置硬件上，听闻国内有小团队直接用树莓派挂块硬盘跑gogs作为公司的代码仓库。至于GitBucket，没试过，猜想应该具有Java一贯的容易部署高内存消耗的特性吧。</p>
<p>之前想装gitlab，都被官方文档的推荐内存要求吓退，最终都换成了gitea/gogs。虽然kvm可以通过swap加大内存绕过，但是好像比较卡，所以都没怎么用过。</p>
<h1 id="section">成果</h1>
<p>测试了下搭建私有gitlab带Web-IDE的持续集成环境。</p>
<p>目前能做到在gitlab网页上编辑一下文件或者本地编辑后push一下，会自动触发gitlab-runner(一个docker虚拟机环境)，进行自动的编译和测试工作。如果编译与测试均成功通过，则进行部署。这样简化软件开发流程。</p>
<p>如下四张图</p>
<h2 id="pipelines--jobs">Pipelines &amp; Jobs</h2>
<p><img src="/images/gitlab1.png" alt="GitLab CI/CD" class="center fancybox"></p>
<p><img src="/images/gitlab4.png" alt="GitLab CI/CD" class="center fancybox"></p>
<h2 id="gitlab-pages">GitLab Pages</h2>
<p><img src="/images/gitlab2.png" alt="GitLab Pages" class="center fancybox"></p>
<p><img src="/images/gitlab3.png" alt="自定义泛解析域名" class="center fancybox"></p>
<h1 id="section-1">安装</h1>
<h2 id="section-2">登录系统初始设置</h2>
<p>我的惯例是如下，首先禁掉密码登录(<code>nano /etc/ssh/sshd_config</code>)，然后更新(<code>apt-get update &amp;&amp; apt-get -y upgrade</code>)，重启(<code>reboot</code>)</p>
<h2 id="section-3">安装常用软件配置等</h2>
<p>这里只随手打一下习惯性手指条件反射记得的包</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption>常用包安装<a href="http://blog.rexdf.org">MyBlog</a></figcaption><div class="highlight pre-code"><table><tr><td class="gutter" aria-hidden="true"><pre class="line-numbers"><div data-line="1" class="line-number"></div><div data-line="2" class="line-number"></div></pre></td><td class="main code"><pre><div class="line bash">apt-get install curl wget bash-completion git bmon htop iftop nano vnstat build-essential language-pack-zh-hans
</div><div class="line bash">locale-gen zh_CN.UTF-8
</div></pre></td></tr></table></div></figure></notextile></div>
<h2 id="gitlab">安装gitlab依赖</h2>
<p>按照我一贯的习惯，能用包管理，尽量用包管理，docker次之，最次脚本安装。直接按照<a href="https://about.gitlab.com/installation/#ubuntu" target="_blank">官方文档</a>就好。</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption>安装gitlab依赖<a href="http://blog.rexdf.org">MyBlog</a></figcaption><div class="highlight pre-code"><table><tr><td class="gutter" aria-hidden="true"><pre class="line-numbers"><div data-line="1" class="line-number"></div><div data-line="2" class="line-number"></div></pre></td><td class="main code"><pre><div class="line bash">sudo apt-get update
</div><div class="line bash">sudo apt-get install -y curl openssh-server ca-certificates postfix
</div></pre></td></tr></table></div></figure></notextile></div>
<h2 id="gitlab-1">安装gitlab</h2>
<p>之前有玩过bitnami的<a href="https://bitnami.com/stack/gitlab" target="_blank">虚拟机版本gitlab</a>，那个是GitLab CE。然而GitLab官方在<a href="https://about.gitlab.com/installation/ce-or-ee/" target="_blank">这里</a>说GitLab Enterprise Edition版本具有社区版本(MIT Expat license)的全部功能，而且能随时使用商业版以及试用过期后回退到社区版。故而直接安装企业版。</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption>安装gitlab官方源<a href="http://blog.rexdf.org">MyBlog</a></figcaption><div class="highlight pre-code"><table><tr><td class="gutter" aria-hidden="true"><pre class="line-numbers"><div data-line="1" class="line-number"></div></pre></td><td class="main code"><pre><div class="line bash">curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.deb.sh | sudo bash
</div></pre></td></tr></table></div></figure></notextile></div>
<p>先加入GitLab官方的源，并导入密钥。</p>
<p>现在去设置一下dns，把域名指向过来。然后就可以通过包管理来安装了</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption>安装gitlab<a href="http://blog.rexdf.org">MyBlog</a></figcaption><div class="highlight pre-code"><table><tr><td class="gutter" aria-hidden="true"><pre class="line-numbers"><div data-line="1" class="line-number"></div></pre></td><td class="main code"><pre><div class="line bash">sudo <span class="nv">EXTERNAL_URL</span><span class="o">=</span><span class="s2">&quot;https://gitlab.rexdf.net&quot;</span> apt-get install gitlab-ee
</div></pre></td></tr></table></div></figure></notextile></div>
<p>小插曲：安装过程中会自动设置letsencrypt证书，我预想的是只是配置而已，然而当我看到letsencrpt字样的dpkg error时，就发现了这安装程序原来集成了自动配置证书功能。</p>
<h2 id="section-4">用户配置</h2>
<p>打开网页就是一个密码输入界面，这里输入的是GitLab的root用户的密码。然后注册了一个普通用户，发现没有任何验证，赶紧用root用户管理员关掉任意用户注册功能。</p>
<h1 id="cicd">配置CI/CD</h1>
<p>我并没有配置太多，只是换了下favicon与logo，然后用普通权限用户的ssh实验了下private项目的pull与push。 具体过程和github与Gitbucket没啥区别，这里不赘述。 当然修改<code>gitlab.rb</code>之后<code>gitlab-ctl reconfigure</code>这个应该也是要养成习惯了。</p>
<h2 id="gitlab-pages-1">自定义域名的GitLab Pages服务</h2>
<p>默认是没有开启Pages服务的。由于有点想当做博客/维基用的想法，所以研究了下。也挺简单，参考<a href="https://docs.gitlab.com/ee/administration/pages/#wildcard-domains-with-tls-support" target="_blank">官方文档</a>，一小时搞定。</p>
<p>首先要泛解析另外一个域名，出于防范XSS攻击考虑，官方不推荐用gitlab服务的主域名。而且gitlab的安装程序目前似乎还不能自动配置泛解析letsencrypt证书。</p>
<p>Let’s Encrypt支持泛解析测试的时候就看到过尝鲜用户的报告。印象中acme.sh是支持得最好的。我用的是如下的指令</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption>签发泛解析域名<a href="http://blog.rexdf.org">MyBlog</a></figcaption><div class="highlight pre-code"><table><tr><td class="gutter" aria-hidden="true"><pre class="line-numbers"><div data-line="1" class="line-number"></div><div data-line="2" class="line-number"></div><div data-line="3" class="line-number"></div><div data-line="4" class="line-number"></div><div data-line="5" class="line-number"></div><div data-line="6" class="line-number"></div><div data-line="7" class="line-number"></div><div data-line="8" class="line-number"></div><div data-line="9" class="line-number"></div><div data-line="10" class="line-number"></div><div data-line="11" class="line-number"></div><div data-line="12" class="line-number"></div><div data-line="13" class="line-number"></div><div data-line="14" class="line-number"></div></pre></td><td class="main code"><pre><div class="line bash"><span class="c">#安装acme.sh(会自动配置alias和crontab等)</span>
</div><div class="line bash">curl https://get.acme.sh | sh
</div><div class="line bash"> </div><div class="line bash"><span class="c">#通过环境变量传递DNSPOD的api key</span>
</div><div class="line bash"><span class="nb">export </span><span class="nv">DP_Id</span><span class="o">=</span><span class="s2">&quot;123456&quot;</span>
</div><div class="line bash"><span class="nb">export </span><span class="nv">DP_Key</span><span class="o">=</span><span class="s2">&quot;14axxxxxbccxxxxx8a25xxxxx6xxxxx9&quot;</span>
</div><div class="line bash"> </div><div class="line bash"><span class="c">#用上面的环境变量签泛解析证书</span>
</div><div class="line bash">acme.sh  --issue  -d <span class="s1">&#39;*.rexdf.com&#39;</span>  --dns dns_dp
</div><div class="line bash"> </div><div class="line bash"><span class="c">#把证书拷贝到gitlab配置目录下</span>
</div><div class="line bash">acme.sh  --installcert -d  <span class="s1">&#39;*.rexdf.com&#39;</span>  <span class="se">\</span>
</div><div class="line bash">--key-file   /etc/gitlab/ssl/rexdf.com.pages.key  <span class="se">\</span>
</div><div class="line bash">--fullchain-file /etc/gitlab/ssl/rexdf.com.pages.crt
</div></pre></td></tr></table></div></figure></notextile></div>
<p>然后修改<code>/etc/gitlab/gitlab.rb</code></p>
<p>找到gitlab pages相关的地方 最终如下</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption>/etc/gitlab/gitlab.rb<a href="http://blog.rexdf.org">MyBlog</a></figcaption><div class="highlight pre-code"><table><tr><td class="gutter" aria-hidden="true"><pre class="line-numbers"><div data-line="1" class="line-number"></div><div data-line="2" class="line-number"></div><div data-line="3" class="line-number"></div><div data-line="4" class="line-number"></div><div data-line="5" class="line-number"></div><div data-line="6" class="line-number"></div></pre></td><td class="main code"><pre><div class="line bash">pages_external_url <span class="s2">&quot;https://rexdf.com/&quot;</span>
</div><div class="line bash">gitlab_pages<span class="o">[</span><span class="s1">&#39;enable&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="nb">true</span>
</div><div class="line bash"> </div><div class="line bash">pages_nginx<span class="o">[</span><span class="s1">&#39;redirect_http_to_https&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="nb">true</span>
</div><div class="line bash">pages_nginx<span class="o">[</span><span class="s1">&#39;ssl_certificate&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;/etc/gitlab/ssl/rexdf.com.pages.crt&quot;</span>
</div><div class="line bash">pages_nginx<span class="o">[</span><span class="s1">&#39;ssl_certificate_key&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;/etc/gitlab/ssl/rexdf.com.pages.key&quot;</span>
</div></pre></td></tr></table></div></figure></notextile></div>
<h2 id="gitlab-runner">配置GitLab Runner</h2>
<p>虽然有openvz官方的<a href="https://wiki.openvz.org/Docker_inside_CT" target="_blank">这篇</a>说明openvz是可以支持docker的，然而我的这个好像不支持，下单时我应该选3.x kernel的。 不过还好gitlab-runner好像就不推荐和gitlab跑在同一个机器上。</p>
<p>在另外一台也是极端便宜的小鸡上装了个gitlab-runner</p>
<h3 id="docker">安装docker</h3>
<p>参考docker<a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/#install-from-a-package" target="_blank">官方文档</a></p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption>安装docker<a href="http://blog.rexdf.org">MyBlog</a></figcaption><div class="highlight pre-code"><table><tr><td class="gutter" aria-hidden="true"><pre class="line-numbers"><div data-line="1" class="line-number"></div><div data-line="2" class="line-number"></div><div data-line="3" class="line-number"></div><div data-line="4" class="line-number"></div><div data-line="5" class="line-number"></div><div data-line="6" class="line-number"></div><div data-line="7" class="line-number"></div><div data-line="8" class="line-number"></div><div data-line="9" class="line-number"></div><div data-line="10" class="line-number"></div><div data-line="11" class="line-number"></div><div data-line="12" class="line-number"></div><div data-line="13" class="line-number"></div><div data-line="14" class="line-number"></div><div data-line="15" class="line-number"></div><div data-line="16" class="line-number"></div></pre></td><td class="main code"><pre><div class="line bash">apt-get install <span class="se">\</span>
</div><div class="line bash">    apt-transport-https <span class="se">\</span>
</div><div class="line bash">    ca-certificates <span class="se">\</span>
</div><div class="line bash">    curl <span class="se">\</span>
</div><div class="line bash">    software-properties-common
</div><div class="line bash"> </div><div class="line bash">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
</div><div class="line bash"> </div><div class="line bash">sudo add-apt-repository <span class="se">\</span>
</div><div class="line bash">   <span class="s2">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span>
</div><div class="line bash"><span class="s2">   $(lsb_release -cs) \</span>
</div><div class="line bash"><span class="s2">   stable&quot;</span>
</div><div class="line bash"> </div><div class="line bash">apt-get update
</div><div class="line bash"> </div><div class="line bash">sudo apt-get install docker-ce
</div></pre></td></tr></table></div></figure></notextile></div>
<h3 id="gitlab-runner-1">安装gitlab-runner及其配置</h3>
<p>参考<a href="https://docs.gitlab.com/runner/install/linux-repository.html" target="_blank">官方文档</a></p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption>安装gitlab-runner<a href="http://blog.rexdf.org">MyBlog</a></figcaption><div class="highlight pre-code"><table><tr><td class="gutter" aria-hidden="true"><pre class="line-numbers"><div data-line="1" class="line-number"></div><div data-line="2" class="line-number"></div></pre></td><td class="main code"><pre><div class="line bash">curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | sudo bash
</div><div class="line bash">sudo apt-get install gitlab-runner
</div></pre></td></tr></table></div></figure></notextile></div>
<p>配置相对来说比较方便,Runner executor选docker，然后镜像选择ruby:2.3就好了</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption>向gitlab注册gitlab-runner<a href="http://blog.rexdf.org">MyBlog</a></figcaption><div class="highlight pre-code"><table><tr><td class="gutter" aria-hidden="true"><pre class="line-numbers"><div data-line="1" class="line-number"></div></pre></td><td class="main code"><pre><div class="line bash">sudo gitlab-runner register
</div></pre></td></tr></table></div></figure></notextile></div>
<p>另外gitlab-runner配置在<code>/etc/gitlab-runner/config.toml</code></p>
<h3 id="section-5">错误</h3>
<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight pre-code"><table><tr><td class="gutter" aria-hidden="true"><pre class="line-numbers"><div data-line="1" class="line-number"></div></pre></td><td class="main code"><pre><div class="line plain">This job is stuck, because you don’t have any active runners that can run this job.
</div></pre></td></tr></table></div></figure></notextile></div>
<p>应该在runner上面勾选<code>Run untagged jobs [] Indicates whether this runner can pick jobs without tags</code></p>
<h1 id="section-6">时间成本</h1>
<p>看了下付款记录，11点付款，下午2点多开始想搭gitlab，到现在写完本文下午6点钟。 整体上比较简单，只要照着官方文档复制粘贴命令就好了。</p>
<h1 id="section-7">维护</h1>
<h2 id="section-8">2018年10月2日</h2>
<p>今天好像Debian系列的libc都升级了，于是惯例升级下系统。然而gitlab这次遇到了点儿问题记录下。</p>
<h3 id="section-9">问题</h3>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption>升级错误<a href="http://blog.rexdf.org">MyBlog</a></figcaption><div class="highlight pre-code"><table><tr><td class="gutter" aria-hidden="true"><pre class="line-numbers"><div data-line="1" class="line-number"></div><div data-line="2" class="line-number"></div><div data-line="3" class="line-number"></div><div data-line="4" class="line-number"></div><div data-line="5" class="line-number"></div><div data-line="6" class="line-number"></div><div data-line="7" class="line-number"></div><div data-line="8" class="line-number"></div><div data-line="9" class="line-number"></div><div data-line="10" class="line-number"></div><div data-line="11" class="line-number"></div><div data-line="12" class="line-number"></div><div data-line="13" class="line-number"></div><div data-line="14" class="line-number"></div><div data-line="15" class="line-number"></div><div data-line="16" class="line-number"></div><div data-line="17" class="line-number"></div><div data-line="18" class="line-number"></div><div data-line="19" class="line-number"></div><div data-line="20" class="line-number"></div><div data-line="21" class="line-number"></div><div data-line="22" class="line-number"></div><div data-line="23" class="line-number"></div><div data-line="24" class="line-number"></div><div data-line="25" class="line-number"></div><div data-line="26" class="line-number"></div><div data-line="27" class="line-number"></div><div data-line="28" class="line-number"></div><div data-line="29" class="line-number"></div><div data-line="30" class="line-number"></div><div data-line="31" class="line-number"></div><div data-line="32" class="line-number"></div><div data-line="33" class="line-number"></div><div data-line="34" class="line-number"></div><div data-line="35" class="line-number"></div><div data-line="36" class="line-number"></div><div data-line="37" class="line-number"></div><div data-line="38" class="line-number"></div><div data-line="39" class="line-number"></div><div data-line="40" class="line-number"></div><div data-line="41" class="line-number"></div><div data-line="42" class="line-number"></div><div data-line="43" class="line-number"></div><div data-line="44" class="line-number"></div><div data-line="45" class="line-number"></div><div data-line="46" class="line-number"></div><div data-line="47" class="line-number"></div><div data-line="48" class="line-number"></div><div data-line="49" class="line-number"></div><div data-line="50" class="line-number"></div><div data-line="51" class="line-number"></div></pre></td><td class="main code"><pre><div class="line bash">apt-get update <span class="o">&amp;&amp;</span> apt-get -y dist-upgrade
</div><div class="line bash">Get:1 http://security.ubuntu.com/ubuntu xenial-security InRelease <span class="o">[</span>107 kB<span class="o">]</span>
</div><div class="line bash">...
</div><div class="line bash">Get:17 http://archive.ubuntu.com/ubuntu xenial-updates/universe Translation-en <span class="o">[</span>279 kB<span class="o">]</span>
</div><div class="line bash">Fetched 3,792 kB in 2s <span class="o">(</span>1,377 kB/s<span class="o">)</span>
</div><div class="line bash">Reading package lists... Done
</div><div class="line bash">Reading package lists... Done
</div><div class="line bash">Building dependency tree
</div><div class="line bash">Reading state information... Done
</div><div class="line bash">Calculating upgrade... Done
</div><div class="line bash">The following packages will be upgraded:
</div><div class="line bash">  gitlab-ee linux-libc-dev
</div><div class="line bash">2 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
</div><div class="line bash">Need to get 494 MB of archives.
</div><div class="line bash">After this operation, 1,921 kB of additional disk space will be used.
</div><div class="line bash">Get:1 http://archive.ubuntu.com/ubuntu xenial-updates/main amd64 linux-libc-dev amd64 4.4.0-137.163 <span class="o">[</span>850 kB<span class="o">]</span>
</div><div class="line bash">Get:2 https://packages.gitlab.com/gitlab/gitlab-ee/ubuntu xenial/main amd64 gitlab-ee amd64 11.3.1-ee.0 <span class="o">[</span>493 MB<span class="o">]</span>
</div><div class="line bash">Fetched 494 MB in 15s <span class="o">(</span>32.8 MB/s<span class="o">)</span>
</div><div class="line bash"><span class="o">(</span>Reading database ... 118431 files and directories currently installed.<span class="o">)</span>
</div><div class="line bash">Preparing to unpack .../linux-libc-dev_4.4.0-137.163_amd64.deb ...
</div><div class="line bash">Unpacking linux-libc-dev:amd64 <span class="o">(</span>4.4.0-137.163<span class="o">)</span> over <span class="o">(</span>4.4.0-135.161<span class="o">)</span> ...
</div><div class="line bash">Preparing to unpack .../gitlab-ee_11.3.1-ee.0_amd64.deb ...
</div><div class="line bash">gitlab preinstall: Automatically backing up only the GitLab SQL database <span class="o">(</span>excluding everything <span class="k">else</span>!<span class="o">)</span>
</div><div class="line bash">Dumping database ...
</div><div class="line bash">Dumping PostgreSQL database gitlabhq_production ... <span class="o">[</span>DONE<span class="o">]</span>
</div><div class="line bash"><span class="k">done</span>
</div><div class="line bash">Dumping repositories ...
</div><div class="line bash"><span class="o">[</span>SKIPPED<span class="o">]</span>
</div><div class="line bash">Dumping uploads ...
</div><div class="line bash"><span class="o">[</span>SKIPPED<span class="o">]</span>
</div><div class="line bash">Dumping builds ...
</div><div class="line bash"><span class="o">[</span>SKIPPED<span class="o">]</span>
</div><div class="line bash">Dumping artifacts ...
</div><div class="line bash"><span class="o">[</span>SKIPPED<span class="o">]</span>
</div><div class="line bash">Dumping pages ...
</div><div class="line bash"><span class="o">[</span>SKIPPED<span class="o">]</span>
</div><div class="line bash">Dumping lfs objects ...
</div><div class="line bash"><span class="o">[</span>SKIPPED<span class="o">]</span>
</div><div class="line bash">Dumping container registry images ...
</div><div class="line bash"><span class="o">[</span>DISABLED<span class="o">]</span>
</div><div class="line bash">Creating backup archive: 1538469788_2018_10_02_11.3.0-ee_gitlab_backup.tar ... <span class="k">done</span>
</div><div class="line bash">Uploading backup archive to remote storage  ... skipped
</div><div class="line bash">Deleting tmp directories ... <span class="k">done</span>
</div><div class="line bash"><span class="k">done</span>
</div><div class="line bash">Deleting old backups ... skipping
</div><div class="line bash">Unpacking gitlab-ee <span class="o">(</span>11.3.1-ee.0<span class="o">)</span> over <span class="o">(</span>11.3.0-ee.0<span class="o">)</span> ...
</div><div class="line bash">dpkg: error processing archive /var/cache/apt/archives/gitlab-ee_11.3.1-ee.0_amd64.deb <span class="o">(</span>--unpack<span class="o">)</span>:
</div><div class="line bash"> unable to stat other new file <span class="s1">&#39;/opt/gitlab/embedded/postgresql/9.6.8/share/extension/lo--1.0--1.1.sql&#39;</span>: Cannot allocate memory
</div><div class="line bash">Errors were encountered <span class="k">while </span>processing:
</div><div class="line bash"> /var/cache/apt/archives/gitlab-ee_11.3.1-ee.0_amd64.deb
</div><div class="line bash">E: Sub-process /usr/bin/dpkg returned an error code <span class="o">(</span>1<span class="o">)</span>
</div></pre></td></tr></table></div></figure></notextile></div>
<p>如果继续运行 <code>apt-get update &amp;&amp; apt-get -y dist-upgrade</code> 则是类似如下的错误</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption>再次安装依然错误<a href="http://blog.rexdf.org">MyBlog</a></figcaption><div class="highlight pre-code"><table><tr><td class="gutter" aria-hidden="true"><pre class="line-numbers"><div data-line="1" class="line-number"></div><div data-line="2" class="line-number"></div><div data-line="3" class="line-number"></div><div data-line="4" class="line-number"></div><div data-line="5" class="line-number"></div><div data-line="6" class="line-number"></div></pre></td><td class="main code"><pre><div class="line bash">dpkg: error processing archive /var/cache/apt/archives/gitlab-ee_11.3.1-ee.0_amd64.deb <span class="o">(</span>--unpack<span class="o">)</span>:
</div><div class="line bash"> unable to stat <span class="s1">&#39;./opt/gitlab/embedded/lib/ruby/gems/2.4.0/gems/graphql-1.8.1/spec/dummy/tmp/cache/assets/sprockets/v3.0/ij/ijLUBXXLleeHIaUQp-SQmpq0HpA44rYlbW5OJbKpnsg.cache&#39;</span> <span class="o">(</span>which I was about to install<span class="o">)</span>: Cannot allocate memory
</div><div class="line bash">dpkg-deb: error: subprocess paste was killed by signal <span class="o">(</span>Broken pipe<span class="o">)</span>
</div><div class="line bash">Errors were encountered <span class="k">while </span>processing:
</div><div class="line bash"> /var/cache/apt/archives/gitlab-ee_11.3.1-ee.0_amd64.deb
</div><div class="line bash">E: Sub-process /usr/bin/dpkg returned an error code <span class="o">(</span>1<span class="o">)</span>
</div></pre></td></tr></table></div></figure></notextile></div>
<h3 id="section-10">探索</h3>
<p>期初我以为是内存的原因，于是<code>/opt/gitlab/bin/gitlab-ctl status</code> 然后 <code>/opt/gitlab/bin/gitlab-ctl stop</code>以及<code>/opt/gitlab/bin/gitlab-ctl start postgresql</code>和<code>/opt/gitlab/bin/gitlab-ctl start postgres-exporter</code>。这样内存占用减小到了206M/4G，而且开了另外一个终端实时监控内存使用情况，发现运行<code>dpkg -i /var/cache/apt/archives/gitlab-ee_11.3.1-ee.0_amd64.deb</code>过程中，内存从来就没超过1G。于是基本否定内存不足的情况了。</p>
<h3 id="section-11">解决</h3>
<p>运行如下三条命令即可解决</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption>解决<a href="http://blog.rexdf.org">MyBlog</a></figcaption><div class="highlight pre-code"><table><tr><td class="gutter" aria-hidden="true"><pre class="line-numbers"><div data-line="1" class="line-number"></div><div data-line="2" class="line-number"></div><div data-line="3" class="line-number"></div><div data-line="4" class="line-number"></div><div data-line="5" class="line-number"></div><div data-line="6" class="line-number"></div><div data-line="7" class="line-number"></div><div data-line="8" class="line-number"></div><div data-line="9" class="line-number"></div><div data-line="10" class="line-number"></div><div data-line="11" class="line-number"></div><div data-line="12" class="line-number"></div><div data-line="13" class="line-number"></div><div data-line="14" class="line-number"></div><div data-line="15" class="line-number"></div></pre></td><td class="main code"><pre><div class="line bash">xx:~# apt-get install -f
</div><div class="line bash">Reading package lists... Done
</div><div class="line bash">Building dependency tree
</div><div class="line bash">Reading state information... Done
</div><div class="line bash">The following packages will be REMOVED:
</div><div class="line bash">  gitlab-ee
</div><div class="line bash">0 upgraded, 0 newly installed, 1 to remove and 0 not upgraded.
</div><div class="line bash">2 not fully installed or removed.
</div><div class="line bash">After this operation, 1,524 MB disk space will be freed.
</div><div class="line bash">Do you want to <span class="k">continue</span>? <span class="o">[</span>Y/n<span class="o">]</span>
</div><div class="line bash"><span class="o">(</span>Reading database ... 118428 files and directories currently installed.<span class="o">)</span>
</div><div class="line bash">Removing gitlab-ee <span class="o">(</span>11.3.0-ee.0<span class="o">)</span> ...
</div><div class="line bash">Setting up linux-libc-dev:amd64 <span class="o">(</span>4.4.0-137.163<span class="o">)</span> ...
</div><div class="line bash">xx:~# dpkg -i /var/cache/apt/archives/gitlab-ee_11.3.1-ee.0_amd64.deb
</div><div class="line bash">xx:~# gitlab-ctl restart
</div></pre></td></tr></table></div></figure></notextile></div>
<h3 id="section-12">真实原因</h3>
<p>老版本依然在运行中，而且没有卸载。所以新版本无法覆盖。</p>
</div>
<footer>
<p class="meta">
<span class="byline author vcard">Posted by <span class="fn">Rexdf</span></span>
<time class="data-article month-09 season-autumn" datetime="2018-09-12T14:21:15+08:00" pubdate><span class="month">Sep</span> <span class="day">12th</span> <span class="year">2018</span></time>
<span class="categories">
<a class="category" href="/blog/categories/sysadmin/">SysAdmin</a>
</span>
</p>
<div class="sharing">
</div>
<p class="meta">
<a class="basic-alignment left" href="/blog/2018/09/10/bo-ke-qie-huan-diao-cha/" title="Previous Post: 博客切换调查">&laquo; 博客切换调查</a>
<a class="basic-alignment right" href="/blog/2018/09/14/geng-xin-liao-xia-bo-ke-zhu-ti/" title="Next Post: 更新了下博客主题">更新了下博客主题 &raquo;</a>
</p>
</footer>
</article>
<section>
<h1>Comments</h1>
<div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
<aside class="sidebar">
<section>
<h1>Categories</h1>
<ul id="categories">
<li class="category"><a href="/blog/categories/acm/">ACM <sup>2</sup></a></li>
<li class="category"><a href="/blog/categories/algorithm/">Algorithm <sup>2</sup></a></li>
<li class="category"><a href="/blog/categories/assembly/">Assembly <sup>1</sup></a></li>
<li class="category"><a href="/blog/categories/cygwin/">Cygwin <sup>3</sup></a></li>
<li class="category"><a href="/blog/categories/gnu/">GNU <sup>8</sup></a></li>
<li class="category"><a href="/blog/categories/math/">Math <sup>1</sup></a></li>
<li class="category"><a href="/blog/categories/octopress/">Octopress <sup>5</sup></a></li>
<li class="category"><a href="/blog/categories/programming/">Programming <sup>6</sup></a></li>
<li class="category"><a href="/blog/categories/security/">Security <sup>1</sup></a></li>
<li class="category"><a href="/blog/categories/sublime/">Sublime <sup>1</sup></a></li>
<li class="category"><a href="/blog/categories/synology/">Synology <sup>1</sup></a></li>
<li class="category"><a href="/blog/categories/sysadmin/">SysAdmin <sup>5</sup></a></li>
<li class="category"><a href="/blog/categories/web/">Web <sup>3</sup></a></li>
<li class="category"><a href="/blog/categories/windows/">Windows <sup>7</sup></a></li>
<li class="category"><a href="/blog/categories/proxmox/">proxmox <sup>1</sup></a></li>
<li class="category"><a href="/blog/categories/ri-chang/">日常 <sup>37</sup></a></li>
</ul>
</section>
<section>
<h1>Recent Posts</h1>
<ul id="recent_posts">
<li class="post">
<a href="/blog/2024/12/16/fu-wu-qi-wa-kuang-bing-du-de-cha-sha/">服务器挖矿病毒的查杀</a>
</li>
<li class="post">
<a href="/blog/2021/07/11/apple-m1-bian-yi-tensorflow/">Apple M1 编译tensorflow</a>
</li>
<li class="post">
<a href="/blog/2021/02/27/chromiumbian-ma-qi-wen-ti/">Chromium编码器问题</a>
</li>
<li class="post">
<a href="/blog/2020/12/13/proxmoxbi-ji/">Proxmox笔记</a>
</li>
<li class="post">
<a href="/blog/2020/11/15/lun-yan-du-yu-shen-du/">论广度与深度</a>
</li>
</ul>
</section>
<section>
<iframe frameborder="0" scrolling="no" referrerpolicy="unsafe-url" style="width:283px;height:200px" src="https://t.rexdf.org/?m=app&a=showwidget&name=rexdf&type=1&width=283px&height=500px"></iframe>
</section>
<section>
<h1>GitHub Repos</h1>
<ul id="gh_repos">
<li class="loading">Status updating...</li>
</ul>
<a href="https://github.com/rexdf">@rexdf</a> on GitHub
<script type="text/javascript">$(document).ready(function(){if(!window.jXHR){var e=document.createElement("script");e.type="text/javascript",e.src="/javascripts/libs/jXHR.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}github.showRepos({user:"rexdf",count:0,skip_forks:!0,target:"#gh_repos"})})</script>
</section>
</aside>
</div>
</div>
<footer role="contentinfo"><p>
<span class="credit">Copyright &copy; 2024 - Rexdf -</span> |
<span class="credit">Powered by <a name="bottoms" target="_blank" href="http://octopress.org">Octopress</a></span> |
<span class="credit">Theme by ：<a href="https://blog.rexdf.org/" target="_blank" rel="theme">Rexdf</a></span> |
<span class="credit">Host by：<a href="https://github.com/" target="_blank" rel="host">Github.com</a></span> |
<span class="credit">版权声明：<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank" rel="license">CC BY-NC-SA 3.0</a><img src="https://analytics.rexdf.net/piwik.php?idsite=1&amp;rec=1" style="border:0" alt="" referrerpolicy="no-referrer-when-downgrade"></span>|
<span class="credit"><a href="/sitemap.xml" rel="sitemap">sitemap</a></span>
</p>
<script type="text/javascript" src="https://tajs.qq.com/stats?sId=30296377" charset="UTF-8"></script>
</footer>
<script type="text/javascript">var disqus_shortname="rexdf",disqus_identifier="https://i.rexdf.org/blog/2018/09/12/da-liao-ge-gitlab/",disqus_url="https://i.rexdf.org/blog/2018/09/12/da-liao-ge-gitlab/",disqus_script="embed.js";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/"+disqus_script,(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script>
<script type="text/javascript">$(function(){$(".entry-content").each(function(t){var r=t;$(this).find("img.fancybox").each(function(){var t=$(this),a=t.attr("title"),n=t.attr("class");t.removeAttr("class"),t.wrap('<a href="'+this.src+'" class="'+n+'" rel="gallery'+r+'" />'),""!=a&&t.parent().attr("title",a)})}),$(".fancybox").fancybox()})</script>
</body>
</html>
